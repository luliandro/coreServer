/* 
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
var http = require("http"),
sax = require('sax'),
fs = require('fs');

exports.journeyplanner = function(req, res){
    console.log("journey planner called");
    //do the request to tfl
    //    var path = "/api/XML_TRIP_REQUEST2?language=en&sessionID=0&place_origin=London&type_origin=locator&name_origin=SE83JU&place_destination=London&type_destination=locator&name_destination=SE13UW";
    //    var options = {
    //        hostname: 'jpapi.tfl.gov.uk',
    //        port: 80,
    //        path: path
    //    };

    var data ="";
    var from;
    parser = sax.parser(false);
    
    parser.ontext = function(t) {
        //data = data + '<br>text=' + t;
        //console.log(from);
        if(parser.tag.name === "ODVNAMEELEM" && from === "" && from === undefined && t !== "" && t !== undefined  ){
            console.log('a', t);
            from = t;
        }
        
    //data += '<br>from=' + t;
    data += '<br>node=' + parser.tag.name + " text " + t;
        
    //console.log('This is the text in that node: ' + t);
    };

    parser.onopentag = function(node) {
        
        if(node.name.toString() === "ITDODVNAME"){
    //data = node.value;
            
    //data += '<br>node=' + node.name;
            
    }
    };
    parser.onend = function(){
        data += "from: " + from;
        res.end(data);
        
    }
    
    try {
        var file_buf = fs.readFileSync('./tflResponse.xml');
        parser.write(file_buf.toString('utf8')).close();
    } catch(ex) {
        console.log(ex);
    // keep 'em silent
    }
//data = JSON.stringify(DataNodeSpace);
    


 
//    http.get(options, function(tflResponse) {
//        tflResponse.on('data', function(chunk){
//            data += chunk;
//
//        }).on("end", function(){
//
//            //            parser=new DOMParser();
//            //            xmlDoc=parser.parseFromString(data,"text/xml");
//            //
//            //            data = xmlDoc.getElementsByTagName("itdTripRequest")[0].childNodes[0].nodeValue;
//
//            res.end(data);
//            res.render('journeyplannerSuccess', {
//                title: "Take me home",
//                xmlData: data
//            })
//        });
//
//    }).on('error', function(e) {
//        console.log("Got error: " + e.message);
//    });
}